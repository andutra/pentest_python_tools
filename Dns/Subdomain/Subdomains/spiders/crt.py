# -*- coding: utf-8 -*-
import scrapy
import re
from datetime import datetime


class CrtSH(scrapy.Spider):
    name = 'CrtSH'
    domain = None
    reStr = '\w+\.'
    subdomains = set()
    baseUrl = 'https://crt.sh/'


    def start_requests(self):
        if self.domain is None:
            self.logger.error("Use scrapy crawl CrtSH -a domain=<domain to search>")
        else:
            self.reStr = self.reStr + self.domain
            yield scrapy.Request(
                url = 'https://crt.sh/?q=' + self.domain,
                callback=self.parse
           )

    def parse(self, response):
        self.subdomains = set(re.findall(self.reStr, response.text))
        for subdomain in self.subdomains:
            shortSub = subdomain.split('.')[0]
            yield {
                    'Domain' : self.domain,
                    'Subdomain' : subdomain,
                    'ShortSubdomain' : shortSub,
                    'SourceSite' : self.name,
                    'InsertDate' : datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 
            }
