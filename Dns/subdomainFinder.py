#/usr/bin/env python
# -*- coding: utf-8 -*-
import requests
import re
import sys
import dns.resolver


baseUrls = ['https://www.google.com/search?q=site%3A{dominio}&num=1500',
            'https://securitytrails.com/list/apex_domain/{dominio}',
            'https://crt.sh/?q={dominio}',
            'https://spyse.com/search/subdomain?q={dominio}',
            'https://api.spyse.com/v1/subdomains?domain={dominio}']

if len(sys.argv) < 2:
    print("Utilize:", sys.argv[0], "dominio.com [dominio2.com] [dominio3.com]")
    exit(-1)


regexBase = '\w+\.'

for domain in sys.argv[1:]:
    subdomains = set()
    regexStr = regexBase + domain
    for url in baseUrls:
        urlToFind = url.replace('{dominio}', domain)
        search = requests.get(urlToFind)
        subdomains |= set(re.findall(regexStr, search.text))
    print(len(subdomains), 'subdominios encontrados para o dominio', domain)

    for subdomain in subdomains:
        try:
            for dnsData in dns.resolver.query(subdomain, 'CNAME'):
                try:
                    resp = requests.get('http://' + subdomain)
                    print(subdomain, '->', dnsData, '->', resp.status_code)
                except:
                    print(subdomain, '->', dnsData, '-> Timeout') 
        except Exception as e:
            pass

    print("\n\n")
