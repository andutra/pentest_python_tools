import sys
import requests
import re
import dns.resolver

if len(sys.argv) < 2:
    print("Utilize:", sys.argv[0], "dominio.com [dominio2.com] [dominio3.com]")
    exit(-1)

apiToken = 'aU6lf4CLyKZTULlZfXIx24vjR6OXfbeT'
url = 'https://api.spyse.com/v1/subdomains?domain=' \
        '{dominio}&page={pagina}&api_token=' + apiToken

regexBase = r'\w+\.'


for domain in sys.argv[1:]:
    subdomains = set()
    regexStr = regexBase + domain
    i = 0
    urlReq = url.replace('{dominio}', domain)
    while True:
        i += 1
        urlPag = urlReq.replace('{pagina}', str(i))
        search = requests.get(urlPag)
        jsonData = search.json()
        if jsonData['records'] is None or len(jsonData['records']) == 0:
            break
        subs = set(re.findall(regexStr, search.text))
        subdomains |= set(subs)
    print(len(subdomains), " encontrados")
    print(subdomains)
    for subdomain in subdomains:
        try:
            for dnsData in dns.resolver.query(subdomain, 'CNAME'):
                msg = "%s -> %s -> " % subdomain, dnsData
            try:
                resp = requests.get('http://' + subdomain)
                print(msg, resp.status_code)
            except Exception as e:
                print(msg, '-> Timeout')
        except Exception as e:
            pass
    print("===================================================")
    print("===================================================")
